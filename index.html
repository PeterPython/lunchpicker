<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Restaurant Selector</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";

    // Firebase configuration with actual keys
    const firebaseConfig = {
      apiKey: "AIzaSyAaihPMwzCZEYQV_pUaffWKqIqxubAlzkc",
      authDomain: "lunch-beda3.firebaseapp.com",
      projectId: "lunch-beda3",
      storageBucket: "lunch-beda3.firebasestorage.app",
      messagingSenderId: "888920791757",
      appId: "1:888920791757:web:848f5a9ce1602e125c2784",
      measurementId: "G-CDDYWJDDE6",
      // Note: Remove the trailing slash if not present in your console snippet.
      databaseURL: "https://lunch-beda3-default-rtdb.firebaseio.com/"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /**
     * Attach a listener to the "restaurants" node in Firebase,
     * repopulating the dropdown whenever the data changes.
     */
    function attachRestaurantListener() {
      const restaurantRef = ref(db, "restaurants");
      onValue(restaurantRef, (snapshot) => {
        const select = document.getElementById("restaurant");
        if (!select) {
          console.error("Element with id 'restaurant' not found in the DOM.");
          return;
        }
        // Clear existing options
        select.innerHTML = "";
        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            const restaurant = childSnapshot.val();
            const option = document.createElement("option");
            option.value = restaurant;
            option.textContent = restaurant;
            select.appendChild(option);
          });
        }
        // Always add the "Choose New" option at the end.
        const newOption = document.createElement("option");
        newOption.value = "Choose New";
        newOption.textContent = "Choose new restaurant";
        select.appendChild(newOption);
      });
    }

    /**
     * Handles changes to the restaurant dropdown.
     * If "Choose New" is selected, it creates an input field and an Add button.
     * When a new restaurant is added, it pushes the value to Firebase and updates the dropdown.
     */
    function handleRestaurantSelection() {
      const select = document.getElementById("restaurant");
      const selectedRestaurantElem = document.getElementById("selectedRestaurant");

      // Check if an input field for a new restaurant already exists.
      let existingInput = document.getElementById("newRestaurantInput");
      let existingButton = document.getElementById("addRestaurantButton");

      if (select.value === "Choose New") {
        // If the new input field doesn't already exist, create it.
        if (!existingInput) {
          // Create a text input for the new restaurant name.
          const newInput = document.createElement("input");
          newInput.type = "text";
          newInput.id = "newRestaurantInput";
          newInput.placeholder = "Enter new restaurant name";

          // Create the Add button.
          const addButton = document.createElement("button");
          addButton.id = "addRestaurantButton";
          addButton.textContent = "Add";

          // When the Add button is clicked, push the new restaurant to Firebase.
          addButton.onclick = function () {
            const newRestaurant = newInput.value.trim();
            if (newRestaurant) {
              push(ref(db, "restaurants"), newRestaurant)
                .then(() => {
                  // Update the display immediately.
                  selectedRestaurantElem.textContent = newRestaurant;
                  // Remove the temporary input and button.
                  newInput.remove();
                  addButton.remove();
                  // Optionally, set the dropdown's value to the newly added restaurant.
                  select.value = newRestaurant;
                })
                .catch((error) => {
                  console.error("Error adding new restaurant:", error);
                });
            } else {
              alert("Please enter a restaurant name.");
            }
          };

          // Insert the input field and Add button right after the dropdown.
          select.parentNode.insertBefore(newInput, select.nextSibling);
          select.parentNode.insertBefore(addButton, newInput.nextSibling);
          newInput.focus();
        }
      } else {
        // If a standard restaurant is selected, remove any temporary input/button.
        if (existingInput) {
          existingInput.remove();
        }
        if (existingButton) {
          existingButton.remove();
        }
        // Update the display with the selected restaurant.
        selectedRestaurantElem.textContent = select.value;
      }
    }

    // Attach the restaurant listener once the DOM is fully loaded.
    document.addEventListener("DOMContentLoaded", () => {
      attachRestaurantListener();
    });

    // Expose the handleRestaurantSelection function to be callable from inline HTML.
    window.handleRestaurantSelection = handleRestaurantSelection;
  </script>
</head>
<body>
  <h1>Restaurant Selector</h1>
  <!-- Dropdown for restaurant selection -->
  <select id="restaurant" onchange="handleRestaurantSelection()"></select>
  <!-- Paragraph to display the currently selected restaurant -->
  <p id="selectedRestaurant"></p>
</body>
</html>
