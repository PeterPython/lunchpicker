<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lunch!</title>
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getDatabase, ref, set, remove, push, onValue } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";

    // Firebase configuration using your actual keys.
    const firebaseConfig = {
      apiKey: "AIzaSyAaihPMwzCZEYQV_pUaffWKqIqxubAlzkc",
      authDomain: "lunch-beda3.firebaseapp.com",
      projectId: "lunch-beda3",
      storageBucket: "lunch-beda3.firebasestorage.app",
      messagingSenderId: "888920791757",
      appId: "1:888920791757:web:848f5a9ce1602e125c2784",
      measurementId: "G-CDDYWJDDE6",
      databaseURL: "https://lunch-beda3-default-rtdb.firebaseio.com/"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Global flag to ensure auto-selection happens only once.
    let autoSelectionMade = false;

    /* ====================================
       Clock & Auto-Selection Functionality
       ==================================== */
    function updateClock() {
      const clockElement = document.getElementById("clock");
      // Use hour12: true for AM/PM format.
      const options = { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
      const timeString = new Intl.DateTimeFormat('en-US', options).format(new Date());
      clockElement.textContent = "Time: " + timeString;
      
      const parts = timeString.split(':');
      const hourPart = parts[0].replace(/\D/g, '');
      const hour = parseInt(hourPart, 10);
      
      // If it's 10am or later and no one is selected, auto-pick a random person.
      if (hour >= 10 && !autoSelectionMade) {
        const selectedPersonElem = document.getElementById("selectedPerson");
        if (!selectedPersonElem.innerText ||
            selectedPersonElem.innerText.trim() === "" ||
            selectedPersonElem.innerText.includes("???")) {
          console.log("Auto selecting random person because it's 10am or later and no one is selected.");
          pickRandomPerson();
          autoSelectionMade = true;
        }
      }
    }

    // Attach a listener for the persistent lunch selection.
    function attachLunchSelectionListener() {
      const lunchSelectionRef = ref(db, "lunchSelection/selectedPerson");
      onValue(lunchSelectionRef, (snapshot) => {
        const selected = snapshot.val();
        const selectedPersonElem = document.getElementById("selectedPerson");
        if (selected) {
          // Display the picked person's name in bold with an exclamation point.
          selectedPersonElem.innerHTML = `<b>${selected}!</b>`;
        } else {
          // Fallback text: "???" without an exclamation point.
          selectedPersonElem.innerHTML = `<b>???</b>`;
        }
      });
    }

    /* ====================================
       Office Attendance Table Functions
       ==================================== */
    function updateCellBackground(name, selected) {
      const cell = document.getElementById("nameCell_" + name);
      if (cell) {
        if (selected === "yes") {
          cell.style.backgroundColor = "green";
          console.log("Set background for " + name + " to green.");
        } else {
          cell.style.backgroundColor = "";
          console.log("Cleared background for " + name + ".");
        }
      } else {
        console.error("Cell not found for " + name);
      }
    }

    // Called when a radio button for a specific person is changed.
    function updateAttendanceFor(name) {
      const radios = document.getElementsByName("officeStatus_" + name);
      let selected = "";
      for (let i = 0; i < radios.length; i++) {
        if (radios[i].checked) {
          selected = radios[i].value;
          break;
        }
      }
      if (selected === "yes") {
        set(ref(db, "officeAttendance/" + name), name)
          .then(() => {
            console.log("Attendance updated for " + name);
            updateCellBackground(name, "yes");
          })
          .catch(error => console.error("Error updating attendance for " + name + ":", error));
      } else if (selected === "no") {
        remove(ref(db, "officeAttendance/" + name))
          .then(() => {
            console.log("Attendance removed for " + name);
            updateCellBackground(name, "no");
          })
          .catch(error => console.error("Error removing attendance for " + name + ":", error));
      }
    }

    // Realtime listener to update the attendance table based on Firebase data.
    function attachOfficeAttendanceListener() {
      const officeAttendanceRef = ref(db, "officeAttendance");
      onValue(officeAttendanceRef, (snapshot) => {
        const names = ["Alec", "Chai", "Cole", "Denis", "Hunter", "Pete"];
        names.forEach(name => {
          const yesRadio = document.querySelector(`input[name="officeStatus_${name}"][value="yes"]`);
          const noRadio = document.querySelector(`input[name="officeStatus_${name}"][value="no"]`);
          if (snapshot.hasChild(name)) {
            if (yesRadio) { yesRadio.checked = true; }
            if (noRadio) { noRadio.checked = false; }
            updateCellBackground(name, "yes");
          } else {
            if (yesRadio) { yesRadio.checked = false; }
            if (noRadio) { noRadio.checked = false; }
            updateCellBackground(name, "no");
          }
        });
      });
    }

    // Picks a random person from those marked "Yes" in the attendance table
    // and persists that selection in Firebase.
    function pickRandomPerson() {
      const rows = document.querySelectorAll("#attendanceTable tbody tr");
      const inOfficeNames = [];
      rows.forEach(row => {
        const name = row.cells[0].textContent;
        const yesRadio = row.querySelector(`input[name="officeStatus_${name}"][value="yes"]`);
        if (yesRadio && yesRadio.checked) {
          inOfficeNames.push(name);
        }
      });
      if (inOfficeNames.length > 0) {
        const randomIndex = Math.floor(Math.random() * inOfficeNames.length);
        const selected = inOfficeNames[randomIndex];
        set(ref(db, "lunchSelection/selectedPerson"), selected)
          .then(() => console.log("Random person selected and persisted:", selected))
          .catch(error => console.error("Error persisting selection:", error));
      } else {
        set(ref(db, "lunchSelection/selectedPerson"), "???");
      }
    }

    function clearOfficeData() {
      remove(ref(db, "officeAttendance"))
        .then(() => console.log("Office attendance cleared"))
        .catch(error => console.error("Error clearing office attendance:", error));
      document.getElementById("selectedPerson").textContent = "";
    }

    /* ====================================
       Restaurant Selector Functions
       ==================================== */
    function attachRestaurantListener() {
      const restaurantRef = ref(db, "restaurants");
      onValue(restaurantRef, (snapshot) => {
        const select = document.getElementById("restaurant");
        if (!select) return;
        const currentValue = select.value;
        select.innerHTML = "";
        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            const restaurant = childSnapshot.val();
            const option = document.createElement("option");
            option.value = restaurant;
            option.textContent = restaurant;
            select.appendChild(option);
          });
        }
        // Always add extra options.
        const chooseNewOption = document.createElement("option");
        chooseNewOption.value = "Choose New";
        chooseNewOption.textContent = "Choose new restaurant";
        select.appendChild(chooseNewOption);

        const pickRandomOption = document.createElement("option");
        pickRandomOption.value = "Pick Random";
        pickRandomOption.textContent = "Pick random restaurant to the dropdown";
        select.appendChild(pickRandomOption);

        if (!currentValue || !Array.from(select.options).some(opt => opt.value === currentValue)) {
          select.value = "Choose New";
        } else {
          select.value = currentValue;
        }
        console.log("Restaurant dropdown updated. Current selection:", select.value);
        if (select.value === "Choose New") {
          handleRestaurantSelection();
        } else if (select.value === "Pick Random") {
          pickRandomRestaurant();
        }
      });
    }

    function handleRestaurantSelection() {
      const select = document.getElementById("restaurant");
      console.log("handleRestaurantSelection triggered. Current selection:", select.value);
      const newRestaurantContainer = document.getElementById("newRestaurantContainer");
      if (!newRestaurantContainer) {
        console.error("New restaurant container not found.");
        return;
      }
      newRestaurantContainer.innerHTML = "";
      if (select.value === "Choose New") {
        console.log("User selected 'Choose New'. Creating input field.");
        const newInput = document.createElement("input");
        newInput.type = "text";
        newInput.id = "newRestaurantInput";
        newInput.placeholder = "New restaurant name";
        const addButton = document.createElement("button");
        addButton.id = "addRestaurantButton";
        addButton.textContent = "Add";
        addButton.onclick = function() {
          console.log("Add button clicked. Input value:", newInput.value);
          const newRestaurant = newInput.value.trim();
          if (newRestaurant) {
            push(ref(db, "restaurants"), newRestaurant)
              .then(() => {
                console.log("New restaurant added:", newRestaurant);
                newRestaurantContainer.innerHTML = "";
                select.value = newRestaurant;
              })
              .catch(error => console.error("Error adding new restaurant:", error));
          } else {
            alert("Please enter a restaurant name.");
          }
        };
        newRestaurantContainer.appendChild(newInput);
        newRestaurantContainer.appendChild(addButton);
        newInput.focus();
      }
    }

    function pickRandomRestaurant() {
      const select = document.getElementById("restaurant");
      if (!select) return;
      const validOptions = Array.from(select.options).filter(opt => opt.value !== "Choose New" && opt.value !== "Pick Random");
      if (validOptions.length === 0) {
        alert("No restaurants available to pick.");
        return;
      }
      const randomIndex = Math.floor(Math.random() * validOptions.length);
      const randomRestaurant = validOptions[randomIndex].value;
      select.value = randomRestaurant;
      console.log("Random restaurant picked:", randomRestaurant);
    }

    function startClock() {
      setInterval(updateClock, 1000);
    }

    document.addEventListener("DOMContentLoaded", () => {
      attachOfficeAttendanceListener();
      attachRestaurantListener();
      attachLunchSelectionListener();
      startClock();
    });

    // Expose functions for inline event handling.
    window.updateAttendanceFor = updateAttendanceFor;
    window.attachOfficeAttendanceListener = attachOfficeAttendanceListener;
    window.attachRestaurantListener = attachRestaurantListener;
    window.handleRestaurantSelection = handleRestaurantSelection;
    window.pickRandomRestaurant = pickRandomRestaurant;
    window.pickRandomPerson = pickRandomPerson;
    window.clearOfficeData = clearOfficeData;
  </script>
</head>
<body>
  <h1>Lunch!</h1>
  
  <!-- Clock Display -->
  <div id="clock" style="font-weight: bold; margin-bottom: 5px;"></div>
  <!-- Deadline Line -->
  <div id="deadline" style="font-weight: bold; margin-bottom: 10px;">Deadline: 10:00 AM</div>
  
  <!-- Office Attendance Table (heading removed) -->
  <table id="attendanceTable" border="1" cellpadding="5">
    <thead>
      <tr>
        <th>Name</th>
        <th>Eating lunch at the office?</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td id="nameCell_Alec">Alec</td>
        <td>
          <label>
            <input type="radio" name="officeStatus_Alec" value="yes" onchange="updateAttendanceFor('Alec')"> Yes
          </label>
          <label>
            <input type="radio" name="officeStatus_Alec" value="no" onchange="updateAttendanceFor('Alec')"> No
          </label>
        </td>
      </tr>
      <tr>
        <td id="nameCell_Chai">Chai</td>
        <td>
          <label>
            <input type="radio" name="officeStatus_Chai" value="yes" onchange="updateAttendanceFor('Chai')"> Yes
          </label>
          <label>
            <input type="radio" name="officeStatus_Chai" value="no" onchange="updateAttendanceFor('Chai')"> No
          </label>
        </td>
      </tr>
      <tr>
        <td id="nameCell_Cole">Cole</td>
        <td>
          <label>
            <input type="radio" name="officeStatus_Cole" value="yes" onchange="updateAttendanceFor('Cole')"> Yes
          </label>
          <label>
            <input type="radio" name="officeStatus_Cole" value="no" onchange="updateAttendanceFor('Cole')"> No
          </label>
        </td>
      </tr>
      <tr>
        <td id="nameCell_Denis">Denis</td>
        <td>
          <label>
            <input type="radio" name="officeStatus_Denis" value="yes" onchange="updateAttendanceFor('Denis')"> Yes
          </label>
          <label>
            <input type="radio" name="officeStatus_Denis" value="no" onchange="updateAttendanceFor('Denis')"> No
          </label>
        </td>
      </tr>
      <tr>
        <td id="nameCell_Hunter">Hunter</td>
        <td>
          <label>
            <input type="radio" name="officeStatus_Hunter" value="yes" onchange="updateAttendanceFor('Hunter')"> Yes
          </label>
          <label>
            <input type="radio" name="officeStatus_Hunter" value="no" onchange="updateAttendanceFor('Hunter')"> No
          </label>
        </td>
      </tr>
      <tr>
        <td id="nameCell_Pete">Pete</td>
        <td>
          <label>
            <input type="radio" name="officeStatus_Pete" value="yes" onchange="updateAttendanceFor('Pete')"> Yes
          </label>
          <label>
            <input type="radio" name="officeStatus_Pete" value="no" onchange="updateAttendanceFor('Pete')"> No
          </label>
        </td>
      </tr>
    </tbody>
  </table>
  
  <!-- White space after the table -->
  <div style="height: 20px;"></div>
  
  <!-- Section for picking a random person (persistent selection) -->
  <button onclick="pickRandomPerson()">Who gets to pick?</button>
  <!-- The selected person text is styled to be the same size as the "Pick a restaurant" heading -->
  <p id="selectedPerson" style="font-size: 2em;"></p>
  
  <!-- RESET button for clearing office attendance data -->
  <button onclick="clearOfficeData()">RESET</button>
  
  <!-- Restaurant Section -->
  <h2>Pick a restaurant</h2>
  <select id="restaurant" onchange="handleRestaurantSelection()"></select>
  <!-- White space between dropdown and new restaurant field -->
  <div style="height: 20px;"></div>
  <div id="newRestaurantContainer"></div>
</body>
</html>
