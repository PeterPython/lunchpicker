<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lunch!</title>
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getDatabase, ref, set, remove, push, onValue } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";

    // Firebase configuration using your actual keys.
    const firebaseConfig = {
      apiKey: "AIzaSyAaihPMwzCZEYQV_pUaffWKqIqxubAlzkc",
      authDomain: "lunch-beda3.firebaseapp.com",
      projectId: "lunch-beda3",
      storageBucket: "lunch-beda3.firebasestorage.app",
      messagingSenderId: "888920791757",
      appId: "1:888920791757:web:848f5a9ce1602e125c2784",
      measurementId: "G-CDDYWJDDE6",
      databaseURL: "https://lunch-beda3-default-rtdb.firebaseio.com/"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* ====================================
       Office Attendance Table Functions
       ==================================== */

    // Called when a radio button for a person is changed.
    // It checks which option (yes/no) is selected, updates Firebase accordingly,
    // and turns the corresponding name cell green if "yes" is selected.
    function updateAttendanceFor(name) {
      const radios = document.getElementsByName("officeStatus_" + name);
      let selected = "";
      for (let i = 0; i < radios.length; i++) {
        if (radios[i].checked) {
          selected = radios[i].value;
          break;
        }
      }
      const cell = document.getElementById("nameCell_" + name);
      if (selected === "yes") {
        set(ref(db, "officeAttendance/" + name), name)
          .then(() => console.log("Attendance updated for " + name))
          .catch(error => console.error("Error updating attendance for " + name + ":", error));
        if (cell) cell.style.backgroundColor = "green";
      } else if (selected === "no") {
        remove(ref(db, "officeAttendance/" + name))
          .then(() => console.log("Attendance removed for " + name))
          .catch(error => console.error("Error removing attendance for " + name + ":", error));
        if (cell) cell.style.backgroundColor = "";
      }
    }

    // Attaches a realtime listener to update the table based on Firebase data.
    // For each fixed name, if an attendance entry exists, it checks the "Yes" radio
    // and turns the name cell green; otherwise, it clears any selection.
    function attachOfficeAttendanceListener() {
      const officeAttendanceRef = ref(db, "officeAttendance");
      onValue(officeAttendanceRef, (snapshot) => {
        const names = ["Alec", "Chai", "Cole", "Denis", "Hunter", "Pete"];
        names.forEach(name => {
          const yesRadio = document.querySelector(`input[name="officeStatus_${name}"][value="yes"]`);
          const noRadio = document.querySelector(`input[name="officeStatus_${name}"][value="no"]`);
          const cell = document.getElementById("nameCell_" + name);
          if (snapshot.hasChild(name)) {
            if (yesRadio) { yesRadio.checked = true; }
            if (noRadio) { noRadio.checked = false; }
            if (cell) { cell.style.backgroundColor = "green"; }
          } else {
            if (yesRadio) { yesRadio.checked = false; }
            if (noRadio) { noRadio.checked = false; }
            if (cell) { cell.style.backgroundColor = ""; }
          }
        });
      });
    }

    /* ====================================
       Restaurant Selector Functions
       ==================================== */

    function attachRestaurantListener() {
      const restaurantRef = ref(db, "restaurants");
      onValue(restaurantRef, (snapshot) => {
        const select = document.getElementById("restaurant");
        if (!select) return;
        const currentValue = select.value;
        select.innerHTML = "";
        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            const restaurant = childSnapshot.val();
            const option = document.createElement("option");
            option.value = restaurant;
            option.textContent = restaurant;
            select.appendChild(option);
          });
        }
        // Always add the "Choose new restaurant" option.
        const newOption = document.createElement("option");
        newOption.value = "Choose New";
        newOption.textContent = "Choose new restaurant";
        select.appendChild(newOption);
        if (!currentValue || !Array.from(select.options).some(opt => opt.value === currentValue)) {
          select.value = "Choose New";
        } else {
          select.value = currentValue;
        }
        console.log("Restaurant dropdown updated. Current selection:", select.value);
        if (select.value === "Choose New") {
          handleRestaurantSelection();
        }
      });
    }

    function handleRestaurantSelection() {
      const select = document.getElementById("restaurant");
      console.log("handleRestaurantSelection triggered. Current selection:", select.value);
      const selectedRestaurantElem = document.getElementById("selectedRestaurant");
      const newRestaurantContainer = document.getElementById("newRestaurantContainer");
      if (!newRestaurantContainer) {
        console.error("New restaurant container not found.");
        return;
      }
      newRestaurantContainer.innerHTML = "";
      if (select.value === "Choose New") {
        console.log("User selected 'Choose New'. Creating input field.");
        const newInput = document.createElement("input");
        newInput.type = "text";
        newInput.id = "newRestaurantInput";
        newInput.placeholder = "Enter new restaurant name";
        const addButton = document.createElement("button");
        addButton.id = "addRestaurantButton";
        addButton.textContent = "Add";
        addButton.onclick = function() {
          console.log("Add button clicked. Input value:", newInput.value);
          const newRestaurant = newInput.value.trim();
          if (newRestaurant) {
            push(ref(db, "restaurants"), newRestaurant)
              .then(() => {
                console.log("New restaurant added:", newRestaurant);
                selectedRestaurantElem.textContent = newRestaurant;
                newRestaurantContainer.innerHTML = "";
                select.value = newRestaurant;
              })
              .catch((error) => console.error("Error adding new restaurant:", error));
          } else {
            alert("Please enter a restaurant name.");
          }
        };
        newRestaurantContainer.appendChild(newInput);
        newRestaurantContainer.appendChild(addButton);
        newInput.focus();
      } else {
        console.log("User selected:", select.value);
        selectedRestaurantElem.textContent = select.value;
      }
    }

    function pickRandomRestaurant() {
      const select = document.getElementById("restaurant");
      if (!select) return;
      // Get all valid restaurant options (excluding "Choose New")
      const validOptions = Array.from(select.options).filter(opt => opt.value !== "Choose New");
      if (validOptions.length === 0) {
        alert("No restaurants available to pick.");
        return;
      }
      const randomIndex = Math.floor(Math.random() * validOptions.length);
      const randomRestaurant = validOptions[randomIndex].value;
      const selectedRestaurantElem = document.getElementById("selectedRestaurant");
      selectedRestaurantElem.textContent = randomRestaurant;
      select.value = randomRestaurant;
      console.log("Random restaurant picked:", randomRestaurant);
    }

    document.addEventListener("DOMContentLoaded", () => {
      attachOfficeAttendanceListener();
      attachRestaurantListener();
    });

    // Expose functions for inline event handling.
    window.updateAttendanceFor = updateAttendanceFor;
    window.attachOfficeAttendanceListener = attachOfficeAttendanceListener;
    window.attachRestaurantListener = attachRestaurantListener;
    window.handleRestaurantSelection = handleRestaurantSelection;
    window.pickRandomRestaurant = pickRandomRestaurant;
  </script>
</head>
<body>
  <h1>Lunch!</h1>
  
  <!-- Office Attendance Table Section -->
  <h2>Office Attendance</h2>
  <table id="attendanceTable" border="1" cellpadding="5">
    <thead>
      <tr>
        <th>Name</th>
        <th>In office?</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td id="nameCell_Alec">Alec</td>
        <td>
          <label>
            <input type="radio" name="officeStatus_Alec" value="yes" onchange="updateAttendanceFor('Alec')"> Yes
          </label>
          <label>
            <input type="radio" name="officeStatus_Alec" value="no" onchange="updateAttendanceFor('Alec')"> No
          </label>
        </td>
      </tr>
      <tr>
        <td id="nameCell_Chai">Chai</td>
        <td>
          <label>
            <input type="radio" name="officeStatus_Chai" value="yes" onchange="updateAttendanceFor('Chai')"> Yes
          </label>
          <label>
            <input type="radio" name="officeStatus_Chai" value="no" onchange="updateAttendanceFor('Chai')"> No
          </label>
        </td>
      </tr>
      <tr>
        <td id="nameCell_Cole">Cole</td>
        <td>
          <label>
            <input type="radio" name="officeStatus_Cole" value="yes" onchange="updateAttendanceFor('Cole')"> Yes
          </label>
          <label>
            <input type="radio" name="officeStatus_Cole" value="no" onchange="updateAttendanceFor('Cole')"> No
          </label>
        </td>
      </tr>
      <tr>
        <td id="nameCell_Denis">Denis</td>
        <td>
          <label>
            <input type="radio" name="officeStatus_Denis" value="yes" onchange="updateAttendanceFor('Denis')"> Yes
          </label>
          <label>
            <input type="radio" name="officeStatus_Denis" value="no" onchange="updateAttendanceFor('Denis')"> No
          </label>
        </td>
      </tr>
      <tr>
        <td id="nameCell_Hunter">Hunter</td>
        <td>
          <label>
            <input type="radio" name="officeStatus_Hunter" value="yes" onchange="updateAttendanceFor('Hunter')"> Yes
          </label>
          <label>
            <input type="radio" name="officeStatus_Hunter" value="no" onchange="updateAttendanceFor('Hunter')"> No
          </label>
        </td>
      </tr>
      <tr>
        <td id="nameCell_Pete">Pete</td>
        <td>
          <label>
            <input type="radio" name="officeStatus_Pete" value="yes" onchange="updateAttendanceFor('Pete')"> Yes
          </label>
          <label>
            <input type="radio" name="officeStatus_Pete" value="no" onchange="updateAttendanceFor('Pete')"> No
          </label>
        </td>
      </tr>
    </tbody>
  </table>
  
  <!-- Restaurants Section -->
  <h2>Restaurants</h2>
  <select id="restaurant" onchange="handleRestaurantSelection()"></select>
  <p id="selectedRestaurant"></p>
  <div id="newRestaurantContainer"></div>
  <button onclick="pickRandomRestaurant()">Pick random restaurant</button>
</body>
</html>
