<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lunch!</title>
  <style>
    /* Ensure h2 headings and the selected person text are 2em */
    h2, #selectedPerson {
      font-size: 2em;
    }
    /* General page styling */
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #fafafa;
      margin: 0;
      padding: 0;
    }
    /* Table styling */
    table {
      margin: 20px auto;
      border-collapse: collapse;
    }
    table, th, td {
      border: 1px solid #333;
    }
    th, td {
      padding: 10px;
    }
    /* Roulette wheel styling */
    #rouletteWheel {
      display: block;
      margin: 20px auto;
      border: 5px solid #333;
      border-radius: 50%;
    }
    #pointer {
      width: 0;
      height: 0;
      margin: 0 auto;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-bottom: 30px solid #333;
      position: relative;
      top: 20px;
    }
  </style>
  <!-- Firebase & Main App Script (as a module) -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getDatabase, ref, set, remove, push, onValue } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";

    // Firebase configuration (use your actual keys)
    const firebaseConfig = {
      apiKey: "AIzaSyAaihPMwzCZEYQV_pUaffWKqIqxubAlzkc",
      authDomain: "lunch-beda3.firebaseapp.com",
      projectId: "lunch-beda3",
      storageBucket: "lunch-beda3.firebasestorage.app",
      messagingSenderId: "888920791757",
      appId: "1:888920791757:web:848f5a9ce1602e125c2784",
      measurementId: "G-CDDYWJDDE6",
      databaseURL: "https://lunch-beda3-default-rtdb.firebaseio.com/"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Global flag to ensure auto-selection happens only once.
    let autoSelectionMade = false;

    // Use the same persons array for attendance and the roulette wheel.
    const persons = ["Alec", "Chai", "Cole", "Denis", "Hunter", "Pete"];
    // Expose persons globally so that the non-module script (roulette code) can access it.
    window.persons = persons;

    /* ====================================
       Clock & Auto-Selection Functionality
       ==================================== */
    function updateClock() {
      const clockElement = document.getElementById("clock");
      if (!clockElement) return;
      const options = { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
      const timeString = new Intl.DateTimeFormat('en-US', options).format(new Date());
      clockElement.textContent = "Time: " + timeString;
      
      const parts = timeString.split(':');
      const hourPart = parts[0].replace(/\D/g, '');
      const hour = parseInt(hourPart, 10);
      
      // Auto-select a random person at 10am or later if none has been chosen yet.
      if (hour >= 10 && !autoSelectionMade) {
        const selectedPersonElem = document.getElementById("selectedPerson");
        if (!selectedPersonElem.innerText ||
            selectedPersonElem.innerText.trim() === "" ||
            selectedPersonElem.innerText.includes("???")) {
          console.log("Auto selecting random person because it's 10am or later and no one is selected.");
          pickRandomPerson();
          autoSelectionMade = true;
        }
      }
    }

    // Attach a listener for the persistent lunch selection.
    function attachLunchSelectionListener() {
      const lunchSelectionRef = ref(db, "lunchSelection/selectedPerson");
      onValue(lunchSelectionRef, (snapshot) => {
        const selected = snapshot.val();
        const selectedPersonElem = document.getElementById("selectedPerson");
        if (selected && selected !== "???") {
          // Display the picked person's name in bold with an exclamation point.
          selectedPersonElem.innerHTML = `<b>${selected}!</b>`;
        } else {
          selectedPersonElem.innerHTML = `<b>???</b>`;
        }
      });
    }

    /* ====================================
       Office Attendance Table Functions
       ==================================== */
    function updateCellBackground(name, selected) {
      const cell = document.getElementById("nameCell_" + name);
      if (cell) {
        cell.style.backgroundColor = selected === "yes" ? "green" : "";
      }
    }

    function updateAttendanceFor(name) {
      const radios = document.getElementsByName("officeStatus_" + name);
      let selected = "";
      for (let radio of radios) {
        if (radio.checked) {
          selected = radio.value;
          break;
        }
      }
      if (selected === "yes") {
        set(ref(db, "officeAttendance/" + name), name)
          .then(() => {
            updateCellBackground(name, "yes");
          })
          .catch(error => console.error("Error updating attendance for " + name + ":", error));
      } else if (selected === "no") {
        remove(ref(db, "officeAttendance/" + name))
          .then(() => {
            updateCellBackground(name, "no");
          })
          .catch(error => console.error("Error removing attendance for " + name + ":", error));
      }
    }

    function attachOfficeAttendanceListener() {
      const officeAttendanceRef = ref(db, "officeAttendance");
      onValue(officeAttendanceRef, (snapshot) => {
        persons.forEach(name => {
          const yesRadio = document.querySelector(`input[name="officeStatus_${name}"][value="yes"]`);
          const noRadio = document.querySelector(`input[name="officeStatus_${name}"][value="no"]`);
          if (snapshot.hasChild(name)) {
            if (yesRadio) yesRadio.checked = true;
            if (noRadio) noRadio.checked = false;
            updateCellBackground(name, "yes");
          } else {
            if (yesRadio) yesRadio.checked = false;
            if (noRadio) noRadio.checked = false;
            updateCellBackground(name, "no");
          }
        });
      });
    }

    function pickRandomPerson() {
      const rows = document.querySelectorAll("#attendanceTable tbody tr");
      const inOfficeNames = [];
      rows.forEach(row => {
        const name = row.cells[0].textContent;
        const yesRadio = row.querySelector(`input[name="officeStatus_${name}"][value="yes"]`);
        if (yesRadio && yesRadio.checked) {
          inOfficeNames.push(name);
        }
      });
      if (inOfficeNames.length > 0) {
        const randomIndex = Math.floor(Math.random() * inOfficeNames.length);
        const selected = inOfficeNames[randomIndex];
        set(ref(db, "lunchSelection/selectedPerson"), selected)
          .then(() => console.log("Random person selected and persisted:", selected))
          .catch(error => console.error("Error persisting selection:", error));
      } else {
        set(ref(db, "lunchSelection/selectedPerson"), "???");
      }
    }

    function clearOfficeData() {
      remove(ref(db, "officeAttendance"))
        .then(() => console.log("Office attendance cleared"))
        .catch(error => console.error("Error clearing office attendance:", error));
      document.getElementById("selectedPerson").textContent = "";
    }

    /* ====================================
       Restaurant Selector Functions
       ==================================== */
    function attachRestaurantListener() {
      const restaurantRef = ref(db, "restaurants");
      onValue(restaurantRef, (snapshot) => {
        const select = document.getElementById("restaurant");
        if (!select) return;
        const currentValue = select.value;
        select.innerHTML = "";
        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            const restaurant = childSnapshot.val();
            const option = document.createElement("option");
            option.value = restaurant;
            option.textContent = restaurant;
            select.appendChild(option);
          });
        }
        // Append the extra option for adding a new restaurant.
        const chooseNewOption = document.createElement("option");
        chooseNewOption.value = "Choose New";
        chooseNewOption.textContent = "Choose new restaurant";
        select.appendChild(chooseNewOption);
        
        select.value = currentValue && Array.from(select.options).some(opt => opt.value === currentValue)
          ? currentValue
          : "Choose New";
          
        if (select.value === "Choose New") {
          handleRestaurantSelection();
        }
      });
    }

    function handleRestaurantSelection() {
      const select = document.getElementById("restaurant");
      const newRestaurantContainer = document.getElementById("newRestaurantContainer");
      newRestaurantContainer.innerHTML = "";
      if (select.value === "Choose New") {
        const newInput = document.createElement("input");
        newInput.type = "text";
        newInput.id = "newRestaurantInput";
        newInput.placeholder = "New restaurant name";
        const addButton = document.createElement("button");
        addButton.id = "addRestaurantButton";
        addButton.textContent = "Add";
        addButton.onclick = function() {
          const newRestaurant = newInput.value.trim();
          if (newRestaurant) {
            push(ref(db, "restaurants"), newRestaurant)
              .then(() => {
                newRestaurantContainer.innerHTML = "";
                select.value = newRestaurant;
              })
              .catch(error => console.error("Error adding new restaurant:", error));
          } else {
            alert("Please enter a restaurant name.");
          }
        };
        newRestaurantContainer.appendChild(newInput);
        newRestaurantContainer.appendChild(addButton);
        newInput.focus();
      }
    }

    function startClock() {
      setInterval(updateClock, 1000);
    }

    document.addEventListener("DOMContentLoaded", () => {
      attachOfficeAttendanceListener();
      attachRestaurantListener();
      attachLunchSelectionListener();
      startClock();
    });

    // Expose functions for inline event handling.
    window.updateAttendanceFor = updateAttendanceFor;
    window.attachOfficeAttendanceListener = attachOfficeAttendanceListener;
    window.attachRestaurantListener = attachRestaurantListener;
    window.handleRestaurantSelection = handleRestaurantSelection;
    window.pickRandomPerson = pickRandomPerson;
    window.clearOfficeData = clearOfficeData;
  </script>
</head>
<body>
  <h1>Lunch!</h1>
  <!-- Clock Display -->
  <div id="clock"></div>
  
  <!-- Office Attendance Section -->
  <h2>Office Attendance</h2>
  <table id="attendanceTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>In Office?</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td id="nameCell_Alec">Alec</td>
        <td>
          <label>
            <input type="radio" name="officeStatus_Alec" value="yes" onclick="updateAttendanceFor('Alec')">
            Yes
          </label>
          <label>
            <input type="radio" name="officeStatus_Alec" value="no" onclick="updateAttendanceFor('Alec')">
            No
          </label>
        </td>
      </tr>
      <tr>
        <td id="nameCell_Chai">Chai</td>
        <td>
          <label>
            <input type="radio" name="officeStatus_Chai" value="yes" onclick="updateAttendanceFor('Chai')">
            Yes
          </label>
          <label>
            <input type="radio" name="officeStatus_Chai" value="no" onclick="updateAttendanceFor('Chai')">
            No
          </label>
        </td>
      </tr>
      <tr>
        <td id="nameCell_Cole">Cole</td>
        <td>
          <label>
            <input type="radio" name="officeStatus_Cole" value="yes" onclick="updateAttendanceFor('Cole')">
            Yes
          </label>
          <label>
            <input type="radio" name="officeStatus_Cole" value="no" onclick="updateAttendanceFor('Cole')">
            No
          </label>
        </td>
      </tr>
      <tr>
        <td id="nameCell_Denis">Denis</td>
        <td>
          <label>
            <input type="radio" name="officeStatus_Denis" value="yes" onclick="updateAttendanceFor('Denis')">
            Yes
          </label>
          <label>
            <input type="radio" name="officeStatus_Denis" value="no" onclick="updateAttendanceFor('Denis')">
            No
          </label>
        </td>
      </tr>
      <tr>
        <td id="nameCell_Hunter">Hunter</td>
        <td>
          <label>
            <input type="radio" name="officeStatus_Hunter" value="yes" onclick="updateAttendanceFor('Hunter')">
            Yes
          </label>
          <label>
            <input type="radio" name="officeStatus_Hunter" value="no" onclick="updateAttendanceFor('Hunter')">
            No
          </label>
        </td>
      </tr>
      <tr>
        <td id="nameCell_Pete">Pete</td>
        <td>
          <label>
            <input type="radio" name="officeStatus_Pete" value="yes" onclick="updateAttendanceFor('Pete')">
            Yes
          </label>
          <label>
            <input type="radio" name="officeStatus_Pete" value="no" onclick="updateAttendanceFor('Pete')">
            No
          </label>
        </td>
      </tr>
    </tbody>
  </table>
  <button onclick="pickRandomPerson()">Pick Random Person for Lunch</button>
  <div id="selectedPerson"><b>???</b></div>
  
  <!-- Roulette Wheel Section -->
  <h2>Roulette Wheel</h2>
  <div id="pointer"></div>
  <canvas id="rouletteWheel" width="400" height="400"></canvas>
  
  <!-- Lunch Options (Restaurant Dropdown) -->
  <h2>Lunch Options</h2>
  <select id="restaurant" onchange="handleRestaurantSelection()"></select>
  <div id="newRestaurantContainer"></div>
  
  <!-- Roulette Wheel Script (Non-module) -->
  <script>
    // Roulette wheel integration:
    const rouletteCanvas = document.getElementById("rouletteWheel");
    const rouletteCtx = rouletteCanvas.getContext("2d");
    const rouletteCenterX = rouletteCanvas.width / 2;
    const rouletteCenterY = rouletteCanvas.height / 2;
    const rouletteRadius = Math.min(rouletteCenterX, rouletteCenterY) - 20;
    // Use the global persons array:
    const rouletteSectors = window.persons.length;
    const rouletteSectorAngle = 2 * Math.PI / rouletteSectors;
    
    let rouletteCurrentAngle = 0;
    
    function drawRouletteWheel() {
      rouletteCtx.clearRect(0, 0, rouletteCanvas.width, rouletteCanvas.height);
      for (let i = 0; i < rouletteSectors; i++) {
        const startAngle = rouletteCurrentAngle + i * rouletteSectorAngle;
        const endAngle = startAngle + rouletteSectorAngle;
        rouletteCtx.fillStyle = i % 2 === 0 ? "#ffdd57" : "#ff6f69";
        rouletteCtx.beginPath();
        rouletteCtx.moveTo(rouletteCenterX, rouletteCenterY);
        rouletteCtx.arc(rouletteCenterX, rouletteCenterY, rouletteRadius, startAngle, endAngle);
        rouletteCtx.closePath();
        rouletteCtx.fill();
        
        // Draw the person's name in the sector.
        rouletteCtx.save();
        rouletteCtx.translate(rouletteCenterX, rouletteCenterY);
        rouletteCtx.rotate(startAngle + rouletteSectorAngle / 2);
        rouletteCtx.textAlign = "right";
        rouletteCtx.fillStyle = "#000";
        rouletteCtx.font = "16px Arial";
        rouletteCtx.fillText(window.persons[i], rouletteRadius - 10, 10);
        rouletteCtx.restore();
      }
    }
    
    drawRouletteWheel();
    
    function spinRouletteWheel(duration = 5000) {
      const startTime = performance.now();
      const initialAngle = rouletteCurrentAngle;
      const totalSpins = 10; // Total full rotations.
      
      function animateRoulette(now) {
        const elapsed = now - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const easedProgress = 1 - Math.pow(1 - progress, 3);
        rouletteCurrentAngle = initialAngle + easedProgress * totalSpins * 2 * Math.PI;
        drawRouletteWheel();
        if (progress < 1) {
          requestAnimationFrame(animateRoulette);
        } else {
          // Determine the winning sector.
          const normalizedAngle = rouletteCurrentAngle % (2 * Math.PI);
          // Adjust for the pointer at the top (Ï€/2).
          const pointerAngle = (2 * Math.PI + Math.PI/2 - normalizedAngle) % (2 * Math.PI);
          const winnerIndex = Math.floor(pointerAngle / rouletteSectorAngle);
          const winner = window.persons[winnerIndex];
          alert("Winner: " + winner);
        }
      }
      requestAnimationFrame(animateRoulette);
    }
    
    rouletteCanvas.addEventListener("click", function() {
      spinRouletteWheel(5000);
    });
  </script>
</body>
</html>
