<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";

  // Your Firebase configuration (make sure to include the databaseURL field)
  const firebaseConfig = {
    apiKey: "YOUR_WEB_API_KEY",
    authDomain: "lunch-beda3.firebaseapp.com",
    projectId: "lunch-beda3",
    storageBucket: "lunch-beda3.appspot.com",
    messagingSenderId: "888920791757",
    appId: "YOUR_APP_ID",
    databaseURL: "https://lunch-beda3-default-rtdb.firebaseio.com/"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Listener for restaurants that updates the dropdown automatically
  function attachRestaurantListener() {
    const restaurantRef = ref(db, "restaurants");
    onValue(restaurantRef, (snapshot) => {
      const select = document.getElementById("restaurant");
      // Clear existing options
      select.innerHTML = "";
      if (snapshot.exists()) {
        snapshot.forEach((childSnapshot) => {
          const restaurant = childSnapshot.val();
          const option = document.createElement("option");
          option.value = restaurant;
          option.textContent = restaurant;
          select.appendChild(option);
        });
      }
      // Always add the "Choose New" option at the end.
      const newOption = document.createElement("option");
      newOption.value = "Choose New";
      newOption.textContent = "Choose new restaurant";
      select.appendChild(newOption);
    });
  }

  // Function to handle restaurant selection changes.
  function handleRestaurantSelection() {
    const select = document.getElementById("restaurant");
    const selectedRestaurantElem = document.getElementById("selectedRestaurant");
    
    // Check if an input field for new restaurant already exists; if so, do nothing.
    let existingInput = document.getElementById("newRestaurantInput");
    let existingButton = document.getElementById("addRestaurantButton");

    if (select.value === "Choose New") {
      // If the new input field does not exist, create it.
      if (!existingInput) {
        // Create a text input for the new restaurant name.
        const newInput = document.createElement("input");
        newInput.type = "text";
        newInput.id = "newRestaurantInput";
        newInput.placeholder = "Enter new restaurant name";

        // Create an "Add" button.
        const addButton = document.createElement("button");
        addButton.textContent = "Add";
        addButton.id = "addRestaurantButton";

        // When the button is clicked, add the new restaurant to Firebase.
        addButton.onclick = function () {
          const newRestaurant = newInput.value.trim();
          if (newRestaurant) {
            push(ref(db, "restaurants"), newRestaurant)
              .then(() => {
                // Optionally update the display immediately.
                selectedRestaurantElem.textContent = newRestaurant;
                // Clear and remove the input and button.
                newInput.value = "";
                newInput.remove();
                addButton.remove();
                // Optionally, set the dropdown's value to the newly added restaurant.
                select.value = newRestaurant;
              })
              .catch((error) => {
                console.error("Error adding new restaurant:", error);
              });
          } else {
            alert("Please enter a restaurant name.");
          }
        };

        // Insert the input and button right after the dropdown.
        select.parentNode.insertBefore(newInput, select.nextSibling);
        select.parentNode.insertBefore(addButton, newInput.nextSibling);
        newInput.focus();
      }
    } else {
      // If a new restaurant was not selected, remove any new input if it exists.
      if (existingInput) {
        existingInput.remove();
      }
      if (existingButton) {
        existingButton.remove();
      }
      // Update the display with the selected restaurant.
      selectedRestaurantElem.textContent = select.value;
    }
  }

  // Attach listeners on DOMContentLoaded.
  document.addEventListener("DOMContentLoaded", () => {
    attachRestaurantListener();
  });

  // Expose the function to the global scope for inline event handling.
  window.handleRestaurantSelection = handleRestaurantSelection;
</script>
