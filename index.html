<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lunch!</title>
  <style>
    /* Ensure h2 headings and the selected person text are 2em */
    h2, #selectedPerson {
      font-size: 2em;
    }
    /* General page styling */
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #fafafa;
      margin: 0;
      padding: 0;
    }
    /* Roulette wheel styling */
    #rouletteWheel {
      display: block;
      margin: 20px auto;
      border: 5px solid #333;
      border-radius: 50%;
    }
    #pointer {
      width: 0;
      height: 0;
      margin: 0 auto;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-bottom: 30px solid #333;
      position: relative;
      top: 20px;
    }
  </style>
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getDatabase, ref, set, remove, push, onValue } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";

    // Firebase configuration using your actual keys.
    const firebaseConfig = {
      apiKey: "AIzaSyAaihPMwzCZEYQV_pUaffWKqIqxubAlzkc",
      authDomain: "lunch-beda3.firebaseapp.com",
      projectId: "lunch-beda3",
      storageBucket: "lunch-beda3.firebasestorage.app",
      messagingSenderId: "888920791757",
      appId: "1:888920791757:web:848f5a9ce1602e125c2784",
      measurementId: "G-CDDYWJDDE6",
      databaseURL: "https://lunch-beda3-default-rtdb.firebaseio.com/"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Global flag to ensure auto-selection happens only once.
    let autoSelectionMade = false;

    // Use the same persons array for attendance and the roulette wheel.
    const persons = ["Alec", "Chai", "Cole", "Denis", "Hunter", "Pete"];

    /* ====================================
       Clock & Auto-Selection Functionality
       ==================================== */
    function updateClock() {
      const clockElement = document.getElementById("clock");
      const options = { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
      const timeString = new Intl.DateTimeFormat('en-US', options).format(new Date());
      clockElement.textContent = "Time: " + timeString;
      
      const parts = timeString.split(':');
      const hourPart = parts[0].replace(/\D/g, '');
      const hour = parseInt(hourPart, 10);
      
      // If it's 10am or later and no one is selected, auto-pick a random person.
      if (hour >= 10 && !autoSelectionMade) {
        const selectedPersonElem = document.getElementById("selectedPerson");
        if (!selectedPersonElem.innerText ||
            selectedPersonElem.innerText.trim() === "" ||
            selectedPersonElem.innerText.includes("???")) {
          console.log("Auto selecting random person because it's 10am or later and no one is selected.");
          pickRandomPerson();
          autoSelectionMade = true;
        }
      }
    }

    // Attach a listener for the persistent lunch selection.
    function attachLunchSelectionListener() {
      const lunchSelectionRef = ref(db, "lunchSelection/selectedPerson");
      onValue(lunchSelectionRef, (snapshot) => {
        const selected = snapshot.val();
        const selectedPersonElem = document.getElementById("selectedPerson");
        if (selected && selected !== "???") {
          // Display the picked person's name in bold with an exclamation point.
          selectedPersonElem.innerHTML = `<b>${selected}!</b>`;
        } else {
          // Fallback text without an exclamation point.
          selectedPersonElem.innerHTML = `<b>???</b>`;
        }
      });
    }

    /* ====================================
       Office Attendance Table Functions
       ==================================== */
    function updateCellBackground(name, selected) {
      const cell = document.getElementById("nameCell_" + name);
      if (cell) {
        if (selected === "yes") {
          cell.style.backgroundColor = "green";
          console.log("Set background for " + name + " to green.");
        } else {
          cell.style.backgroundColor = "";
          console.log("Cleared background for " + name + ".");
        }
      } else {
        console.error("Cell not found for " + name);
      }
    }

    function updateAttendanceFor(name) {
      const radios = document.getElementsByName("officeStatus_" + name);
      let selected = "";
      for (let i = 0; i < radios.length; i++) {
        if (radios[i].checked) {
          selected = radios[i].value;
          break;
        }
      }
      if (selected === "yes") {
        set(ref(db, "officeAttendance/" + name), name)
          .then(() => {
            console.log("Attendance updated for " + name);
            updateCellBackground(name, "yes");
          })
          .catch(error => console.error("Error updating attendance for " + name + ":", error));
      } else if (selected === "no") {
        remove(ref(db, "officeAttendance/" + name))
          .then(() => {
            console.log("Attendance removed for " + name);
            updateCellBackground(name, "no");
          })
          .catch(error => console.error("Error removing attendance for " + name + ":", error));
      }
    }

    function attachOfficeAttendanceListener() {
      const officeAttendanceRef = ref(db, "officeAttendance");
      onValue(officeAttendanceRef, (snapshot) => {
        persons.forEach(name => {
          const yesRadio = document.querySelector(`input[name="officeStatus_${name}"][value="yes"]`);
          const noRadio = document.querySelector(`input[name="officeStatus_${name}"][value="no"]`);
          if (snapshot.hasChild(name)) {
            if (yesRadio) { yesRadio.checked = true; }
            if (noRadio) { noRadio.checked = false; }
            updateCellBackground(name, "yes");
          } else {
            if (yesRadio) { yesRadio.checked = false; }
            if (noRadio) { noRadio.checked = false; }
            updateCellBackground(name, "no");
          }
        });
      });
    }

    function pickRandomPerson() {
      const rows = document.querySelectorAll("#attendanceTable tbody tr");
      const inOfficeNames = [];
      rows.forEach(row => {
        const name = row.cells[0].textContent;
        const yesRadio = row.querySelector(`input[name="officeStatus_${name}"][value="yes"]`);
        if (yesRadio && yesRadio.checked) {
          inOfficeNames.push(name);
        }
      });
      if (inOfficeNames.length > 0) {
        const randomIndex = Math.floor(Math.random() * inOfficeNames.length);
        const selected = inOfficeNames[randomIndex];
        set(ref(db, "lunchSelection/selectedPerson"), selected)
          .then(() => console.log("Random person selected and persisted:", selected))
          .catch(error => console.error("Error persisting selection:", error));
      } else {
        set(ref(db, "lunchSelection/selectedPerson"), "???");
      }
    }

    function clearOfficeData() {
      remove(ref(db, "officeAttendance"))
        .then(() => console.log("Office attendance cleared"))
        .catch(error => console.error("Error clearing office attendance:", error));
      document.getElementById("selectedPerson").textContent = "";
    }

    /* ====================================
       Restaurant Selector Functions
       ==================================== */
    function attachRestaurantListener() {
      const restaurantRef = ref(db, "restaurants");
      onValue(restaurantRef, (snapshot) => {
        const select = document.getElementById("restaurant");
        if (!select) return;
        const currentValue = select.value;
        select.innerHTML = "";
        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            const restaurant = childSnapshot.val();
            const option = document.createElement("option");
            option.value = restaurant;
            option.textContent = restaurant;
            select.appendChild(option);
          });
        }
        // Append the extra option for adding a new restaurant.
        const chooseNewOption = document.createElement("option");
        chooseNewOption.value = "Choose New";
        chooseNewOption.textContent = "Choose new restaurant";
        select.appendChild(chooseNewOption);
        
        if (!currentValue || !Array.from(select.options).some(opt => opt.value === currentValue)) {
          select.value = "Choose New";
        } else {
          select.value = currentValue;
        }
        console.log("Restaurant dropdown updated. Current selection:", select.value);
        if (select.value === "Choose New") {
          handleRestaurantSelection();
        }
      });
    }

    function handleRestaurantSelection() {
      const select = document.getElementById("restaurant");
      console.log("handleRestaurantSelection triggered. Current selection:", select.value);
      const newRestaurantContainer = document.getElementById("newRestaurantContainer");
      if (!newRestaurantContainer) {
        console.error("New restaurant container not found.");
        return;
      }
      newRestaurantContainer.innerHTML = "";
      if (select.value === "Choose New") {
        console.log("User selected 'Choose New'. Creating input field.");
        const newInput = document.createElement("input");
        newInput.type = "text";
        newInput.id = "newRestaurantInput";
        newInput.placeholder = "New restaurant name";
        const addButton = document.createElement("button");
        addButton.id = "addRestaurantButton";
        addButton.textContent = "Add";
        addButton.onclick = function() {
          console.log("Add button clicked. Input value:", newInput.value);
          const newRestaurant = newInput.value.trim();
          if (newRestaurant) {
            push(ref(db, "restaurants"), newRestaurant)
              .then(() => {
                console.log("New restaurant added:", newRestaurant);
                newRestaurantContainer.innerHTML = "";
                select.value = newRestaurant;
              })
              .catch(error => console.error("Error adding new restaurant:", error));
          } else {
            alert("Please enter a restaurant name.");
          }
        };
        newRestaurantContainer.appendChild(newInput);
        newRestaurantContainer.appendChild(addButton);
        newInput.focus();
      }
    }

    function startClock() {
      setInterval(updateClock, 1000);
    }

    document.addEventListener("DOMContentLoaded", () => {
      attachOfficeAttendanceListener();
      attachRestaurantListener();
      attachLunchSelectionListener();
      startClock();
    });

    // Expose functions for inline event handling.
    window.updateAttendanceFor = updateAttendanceFor;
    window.attachOfficeAttendanceListener = attachOfficeAttendanceListener;
    window.attachRestaurantListener = attachRestaurantListener;
    window.handleRestaurantSelection = handleRestaurantSelection;
    window.pickRandomPerson = pickRandomPerson;
    window.clearOfficeData = clearOfficeData;
  </script>
  
  <!-- End of Firebase and Lunch! app code -->
  
  <!-- New Section: Roulette Wheel -->
  <h2>Roulette Wheel</h2>
  <!-- Pointer arrow above the wheel -->
  <div id="pointer"></div>
  <!-- Canvas for the roulette wheel -->
  <canvas id="rouletteWheel" width="400" height="400"></canvas>
  <script>
    // Roulette wheel integration:
    const rouletteCanvas = document.getElementById("rouletteWheel");
    const rouletteCtx = rouletteCanvas.getContext("2d");
    const rouletteCenterX = rouletteCanvas.width / 2;
    const rouletteCenterY = rouletteCanvas.height / 2;
    const rouletteRadius = Math.min(rouletteCenterX, rouletteCenterY) - 20;
    const rouletteSectors = persons.length; // Use the persons array from above.
    const rouletteSectorAngle = 2 * Math.PI / rouletteSectors;
    
    let rouletteCurrentAngle = 0;
    
    function drawRouletteWheel() {
      rouletteCtx.clearRect(0, 0, rouletteCanvas.width, rouletteCanvas.height);
      for (let i = 0; i < rouletteSectors; i++) {
        const startAngle = rouletteCurrentAngle + i * rouletteSectorAngle;
        const endAngle = startAngle + rouletteSectorAngle;
        rouletteCtx.fillStyle = i % 2 === 0 ? "#ffdd57" : "#ff6f69";
        rouletteCtx.beginPath();
        rouletteCtx.moveTo(rouletteCenterX, rouletteCenterY);
        rouletteCtx.arc(rouletteCenterX, rouletteCenterY, rouletteRadius, startAngle, endAngle);
        rouletteCtx.closePath();
        rouletteCtx.fill();
        
        // Draw the person's name in the sector.
        rouletteCtx.save();
        rouletteCtx.translate(rouletteCenterX, rouletteCenterY);
        rouletteCtx.rotate(startAngle + rouletteSectorAngle / 2);
        rouletteCtx.textAlign = "right";
        rouletteCtx.fillStyle = "#000";
        rouletteCtx.font = "16px Arial";
        rouletteCtx.fillText(persons[i], rouletteRadius - 10, 10);
        rouletteCtx.restore();
      }
    }
    
    drawRouletteWheel();
    
    function spinRouletteWheel(duration = 5000) {
      const startTime = performance.now();
      const initialAngle = rouletteCurrentAngle;
      const totalSpins = 10; // Total full rotations.
      
      function animateRoulette(now) {
        const elapsed = now - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const easedProgress = 1 - Math.pow(1 - progress, 3);
        rouletteCurrentAngle = initialAngle + easedProgress * totalSpins * 2 * Math.PI;
        drawRouletteWheel();
        if (progress < 1) {
          requestAnimationFrame(animateRoulette);
        } else {
          // Determine the winning sector.
          const normalizedAngle = rouletteCurrentAngle % (2 * Math.PI);
          // Adjust for the pointer at the top (Ï€/2).
          const pointerAngle = (2 * Math.PI + Math.PI/2 - normalizedAngle) % (2 * Math.PI);
          const winnerIndex = Math.floor(pointerAngle / rouletteSectorAngle);
          const winner = persons[winnerIndex];
          alert("Winner: " + winner);
        }
      }
      requestAnimationFrame(animateRoulette);
    }
    
    rouletteCanvas.addEventListener("click", function() {
      spinRouletteWheel(5000);
    });
  </script>
</body>
</html>
