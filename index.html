<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lunch Lottery</title>
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getDatabase, ref, set, remove, push, onValue } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";

    // Firebase configuration (using your actual keys)
    const firebaseConfig = {
      apiKey: "AIzaSyAaihPMwzCZEYQV_pUaffWKqIqxubAlzkc",
      authDomain: "lunch-beda3.firebaseapp.com",
      projectId: "lunch-beda3",
      storageBucket: "lunch-beda3.firebasestorage.app",
      messagingSenderId: "888920791757",
      appId: "1:888920791757:web:848f5a9ce1602e125c2784",
      measurementId: "G-CDDYWJDDE6",
      databaseURL: "https://lunch-beda3-default-rtdb.firebaseio.com/"
    };

    // Initialize Firebase and get the database reference.
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* ==============================
       Office Attendance Functions
       ============================== */

    // Called when the radio buttons change.
    // Uses the currently selected name and adds (or removes) it from the office attendance node.
    function updateAttendance() {
      const nameSelect = document.getElementById("name");
      const name = nameSelect.value;
      const selectedRadio = document.querySelector('input[name="officeStatus"]:checked');
      if (!selectedRadio) {
        // No option selected—do nothing.
        return;
      }
      const inOffice = selectedRadio.value;
      if (inOffice === "yes") {
        // Use the person's name as a key so that changes update the record.
        set(ref(db, "officeAttendance/" + name), name)
          .then(() => console.log("Attendance updated for:", name))
          .catch((error) => console.error("Error updating attendance:", error));
      } else if (inOffice === "no") {
        remove(ref(db, "officeAttendance/" + name))
          .then(() => console.log("Attendance removed for:", name))
          .catch((error) => console.error("Error removing attendance:", error));
      }
    }

    // Called when the name dropdown changes.
    // Clears any radio button selection so that the new person’s attendance must be reselected.
    function nameChanged() {
      Array.from(document.getElementsByName("officeStatus")).forEach(radio => {
        radio.checked = false;
      });
      // Call updateAttendance (which now will not find a radio selection).
      updateAttendance();
    }

    // Listens to the "officeAttendance" node and updates the "In Office" list.
    function attachOfficeAttendanceListener() {
      const officeAttendanceRef = ref(db, "officeAttendance");
      onValue(officeAttendanceRef, (snapshot) => {
        const list = document.getElementById("officeList");
        if (!list) return;
        list.innerHTML = "";
        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            const attendee = childSnapshot.val();
            const li = document.createElement("li");
            li.textContent = attendee;
            list.appendChild(li);
          });
        }
      });
    }

    // Picks a random person from the "In Office" list.
    function pickRandomPerson() {
      const listItems = document.querySelectorAll("#officeList li");
      const selectedPersonElem = document.getElementById("selectedPerson");
      if (listItems.length > 0) {
        const randomIndex = Math.floor(Math.random() * listItems.length);
        selectedPersonElem.textContent = `Selected: ${listItems[randomIndex].textContent}`;
      } else {
        selectedPersonElem.textContent = "No one is in the office.";
      }
    }

    // Clears only the office attendance data.
    function clearOfficeData() {
      remove(ref(db, "officeAttendance"))
        .then(() => console.log("Office attendance cleared"))
        .catch((error) => console.error("Error clearing office attendance:", error));
      document.getElementById("selectedPerson").textContent = "";
    }

    /* ==============================
       Restaurant Selector Functions
       ============================== */

    // Attaches a realtime listener to populate the restaurant dropdown.
    function attachRestaurantListener() {
      const restaurantRef = ref(db, "restaurants");
      onValue(restaurantRef, (snapshot) => {
        const select = document.getElementById("restaurant");
        if (!select) return;
        // Preserve current selection, if any.
        const currentValue = select.value;
        select.innerHTML = "";
        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            const restaurant = childSnapshot.val();
            const option = document.createElement("option");
            option.value = restaurant;
            option.textContent = restaurant;
            select.appendChild(option);
          });
        }
        // Always add the "Choose new restaurant" option at the end.
        const newOption = document.createElement("option");
        newOption.value = "Choose New";
        newOption.textContent = "Choose new restaurant";
        select.appendChild(newOption);
        // Re-select the previous value if it still exists.
        if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
          select.value = currentValue;
        }
      });
    }

    // Handles changes in the restaurant dropdown.
    // When "Choose New" is selected, displays a text input and an Add button.
    function handleRestaurantSelection() {
      const select = document.getElementById("restaurant");
      const selectedRestaurantElem = document.getElementById("selectedRestaurant");
      const newRestaurantContainer = document.getElementById("newRestaurantContainer");
      if (!newRestaurantContainer) {
        console.error("New restaurant container not found.");
        return;
      }
      // Clear any existing input/button.
      newRestaurantContainer.innerHTML = "";
      if (select.value === "Choose New") {
        // Create a text input field for the new restaurant name.
        const newInput = document.createElement("input");
        newInput.type = "text";
        newInput.id = "newRestaurantInput";
        newInput.placeholder = "Enter new restaurant name";
        // Create an Add button.
        const addButton = document.createElement("button");
        addButton.id = "addRestaurantButton";
        addButton.textContent = "Add";
        // When the button is clicked, push the new restaurant to Firebase.
        addButton.onclick = function() {
          const newRestaurant = newInput.value.trim();
          if (newRestaurant) {
            push(ref(db, "restaurants"), newRestaurant)
              .then(() => {
                selectedRestaurantElem.textContent = newRestaurant;
                // Clear the input/button container.
                newRestaurantContainer.innerHTML = "";
                // Update the dropdown's selected value (the realtime listener will update the options shortly).
                select.value = newRestaurant;
              })
              .catch((error) => console.error("Error adding new restaurant:", error));
          } else {
            alert("Please enter a restaurant name.");
          }
        };
        // Append the input and button to the dedicated container.
        newRestaurantContainer.appendChild(newInput);
        newRestaurantContainer.appendChild(addButton);
        newInput.focus();
      } else {
        // For any selection other than "Choose New", simply update the display.
        selectedRestaurantElem.textContent = select.value;
      }
    }

    // Attach realtime listeners when the DOM is ready.
    document.addEventListener("DOMContentLoaded", () => {
      attachOfficeAttendanceListener();
      attachRestaurantListener();
    });

    // Expose functions for inline event handling.
    window.updateAttendance = updateAttendance;
    window.nameChanged = nameChanged;
    window.pickRandomPerson = pickRandomPerson;
    window.clearOfficeData = clearOfficeData;
    window.handleRestaurantSelection = handleRestaurantSelection;
  </script>
</head>
<body>
  <h1>Lunch Lottery</h1>
  
  <!-- Office Attendance Section -->
  <h2>Will you be in the office today?</h2>
  <label for="name">Select your name:</label>
  <!-- When the name changes, clear the radio buttons -->
  <select id="name" onchange="nameChanged()">
    <option value="Alec">Alec</option>
    <option value="Chai">Chai</option>
    <option value="Cole">Cole</option>
    <option value="Denis">Denis</option>
    <option value="Hunter">Hunter</option>
    <option value="Pete">Pete</option>
  </select>
  <br>
  <!-- Radio buttons for office status; each calls updateAttendance() when changed -->
  <label>
    <input type="radio" name="officeStatus" value="yes" onchange="updateAttendance()"> Yes
  </label>
  <label>
    <input type="radio" name="officeStatus" value="no" onchange="updateAttendance()"> No
  </label>
  
  <h2>In Office</h2>
  <ul id="officeList"></ul>
  
  <h2>Pick a Random Person</h2>
  <button onclick="pickRandomPerson()">Pick</button>
  <p id="selectedPerson"></p>
  
  <!-- Clear Office Data Section (placed above the restaurant selector) -->
  <h2>Clear Office Data</h2>
  <button onclick="clearOfficeData()">Clear Office Data</button>
  
  <!-- Restaurant Selector Section -->
  <h2>Restaurant Selector</h2>
  <select id="restaurant" onchange="handleRestaurantSelection()"></select>
  <p id="selectedRestaurant"></p>
  <!-- Container where the new restaurant input and Add button will appear -->
  <div id="newRestaurantContainer"></div>
</body>
</html>
